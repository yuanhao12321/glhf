/*! wanmeizhiyuan 2019-07-09 */

define(["jquery","pin","common/pinData","widget/select","request"],function($,pin,pinData,selectUi,Req){window.showScoreUi="preloading";var vipProvs=pin.getCfg("vipProvs"),limitConfig=pin.getCfg("limitConfig"),provinceLock=limitConfig.provinceLock,scoreModifyProvs=limitConfig.scoreModifyProvs,scoreRequireProvs=limitConfig.scoreRequireProvs,diplomaRequireProvs=["11","31","36"],modifyLimitTimes=1,PageData=$.extend({},window.PageData),getCfg=function(name){return PageData[name]},myScore=getCfg("myScore"),hasScore=myScore.realScore>0,scorepaneWarp=['<div class="pop-dialog pop-score-dialog win-fixed" ms-class="pop-min-dialog:notAllowClose" ms-visible="display">','    <div class="win-pop">','        <div class="inner">','            <div class="hd" style="margin:0;">','                <a href="#" ms-if="!notAllowClose" class="btn-close" ms-click="closeFn">×</a> ',"            </div>",'            <div class="bd js-warp">',"            </div>","        </div>","    </div>","</div>"].join(""),showScore=function(myScore,callback,options){function getProvName(prov){for(var provName,i=0;i<getProtext.length;i++)if(getProtext[i].value==prov){provName=getProtext[i].text.replace(/[\w\s]/g,"");break}return provName}var vm=avalon.vmodels.score,updateCallback=callback||function(){};if(vm)return vm.updateCallback=updateCallback,vm;var showMsg=function(msg){pin.use("richAlert",{alertType:"warn",title:msg,content:""}).display(1)};options=options||{};var element,recommend=!!options.recommend,notAllowClose=!!options.notAllowClose||!1;if(recommend)notAllowClose=!0,element=$(options.element),element.find(".form_btn").text("开始推荐学校");else{element=$(scorepaneWarp);var scorePaneTpl=document.getElementById("scorePane").innerHTML;element.find(".js-warp").append(scorePaneTpl),element.find(".g-form").css({top:"0",right:"-70px"}),"sogou"==myScore.score_form&&"32"==myScore.prov&&myScore.realScore>0&&myScore.realScore<=480&&!myScore.req_course?element.find(".m-title").text("江苏考生需输入学科成绩"):(myScore.score_form,element.find(".form_btn").text("确定"));var mask=$('<div class="mask" style="display: none;z-index: 1010;"></div>');mask.appendTo("body"),element.appendTo("body")}var provinceConfigList=pinData.provinceConfigList,getProtext=[];provinceConfigList.forEach(function(p){getProtext.push({text:p.py+"  "+p.prov,value:p.pid})});var req_courseCfg,jiangsuCourseCfg=pinData.jiangsuCourseCfg;req_courseCfg=myScore.req_course?pinData.getCourse(myScore.req_course):jiangsuCourseCfg.req_course[1==myScore.wenli?"wen":"li"],myScore.diploma_id=1*myScore.diploma_id||7,myScore.score=myScore.score>=0?myScore.score:"",myScore.realScore=myScore.realScore>0?myScore.realScore:"",myScore.scoreRank=myScore.scoreRank>0?myScore.scoreRank:"",myScore.inputScoreRank=myScore.inputScoreRank>0?myScore.inputScoreRank:"",myScore.req_courseCfg=req_courseCfg,myScore.req_course=req_courseCfg.value,myScore.opt_course=myScore.opt_course||jiangsuCourseCfg.opt_courseList[0].value,myScore.req_level=myScore.req_level||jiangsuCourseCfg.courseLevels[0],myScore.opt_level=myScore.opt_level||jiangsuCourseCfg.courseLevels[0],myScore.zj_opt_course=myScore.zj_opt_course||[],myScore.update_count=Math.max(myScore.update_count>>0,0),myScore.opt_courseCfg={biology:"生物",chemistry:"化学",geography:"地理",politics:"政治"};var scoreInfo=avalon.mix({},myScore),oldScoreInfo=avalon.mix({},myScore),vmodel=avalon.define({$id:"score",saveScoreForm:myScore.score_form||"scoreBox",display:!1,notAllowClose:notAllowClose,updateCallback:updateCallback,title:notAllowClose?myScore.score?"预测录取概率功能已上线,<br />马上输入你的排名试试看":"根据分数，为你推荐完美志愿":"修改成绩",score:scoreInfo,hasScore:hasScore,provLock:provinceLock,isXz:"31"===myScore.prov||"33"===myScore.prov,$opt_course_list:{value:myScore.opt_course,data:jiangsuCourseCfg.opt_courseList,$mustHaveValue:!0,onChange:function(v){vmodel.score.opt_course=v}},$req_level_list:{value:myScore.req_level,data:jiangsuCourseCfg.courseLevels,$mustHaveValue:!0,onChange:function(v){vmodel.score.req_level=v}},$opt_level_list:{value:myScore.opt_level,data:jiangsuCourseCfg.courseLevels,$mustHaveValue:!0,onChange:function(v){vmodel.score.opt_level=v}},$prov_list:{value:myScore.prov,data:getProtext,$mustHaveValue:!0,onChange:function(pid){if("31"==pid||"33"==pid)return window.zhejiangTipPopup(function(){}),!1;if(-1==diplomaRequireProvs.indexOf(pid+"")?vmodel.score.diploma_id="":vmodel.score.diploma_id=7,vipProvs.length>0&&-1==vipProvs.indexOf(pid+""))if(1==vipProvs.length){var provNameOfCard=getProvName(vipProvs[0]);alert('您的VIP权限仅限于<span style="color:red">'+provNameOfCard+"</span>使用，请及时切换回有效省份，否则VIP权限将失效。")}else if(vipProvs.length>1){var curProName=getProvName(pid);alert('您的VIP权限不能在<span style="color:red">'+curProName+"</span>使用，请及时切换回有效省份，否则VIP权限将失效。")}return vmodel.score.zj_opt_course=[],$(".ui-checkbox-group").children().css("opacity","1"),vmodel.isXz="31"===pid||"33"===pid,$(".js-prov").css({width:vmodel.isXz?"272px":"125px"}),!0}},modifyLimitTimes:modifyLimitTimes,modifyLimit:{get:function(){return scoreModifyProvs.indexOf((vmodel&&vmodel.score||oldScoreInfo).prov+"")>-1&&oldScoreInfo.update_count<=modifyLimitTimes}},allowModify:{get:function(){return!this.modifyLimit||oldScoreInfo.update_count>0}},rankRequire:{get:function(){return scoreRequireProvs.indexOf(this.score.prov+"")>-1}},diplomaRequire:{get:function(){return diplomaRequireProvs.indexOf(this.score.prov+"")>-1}},provName:{get:function(){return getProvName(this.score.prov)}},changewl:function(v,e){return vmodel.score.wenli=v,vmodel.score.req_courseCfg=jiangsuCourseCfg.req_course[1==v?"wen":"li"],vmodel.score.req_course=vmodel.score.req_courseCfg.value,e.preventDefault(),!1},changeDiploma:function(v,e){return vmodel.score.diploma_id=v,e.preventDefault(),!1},clickCourse:function(v,e){return vmodel.score.zj_opt_course.indexOf(v)>-1?vmodel.score.zj_opt_course.remove(v):vmodel.score.zj_opt_course.length<3&&vmodel.score.zj_opt_course.push(v),vmodel.score.zj_opt_course.length>=3?$(".ui-checkbox-group .ui-checkbox").each(function(index,item){$(this).find(".ui-checkbox-value").hasClass("ui-checked")||$(this).css("opacity","0.5")}):$(".ui-checkbox-group").children().css("opacity","1"),e.preventDefault(),!1},isLocked:function(myScore){if(myScore=myScore||vmodel.score.$model,!vmodel.allowModify&&vmodel.scoreHasChange(myScore)){for(var paramKeys=vmodel.scoreKeys(myScore),i=0;i<paramKeys.length;i++)vmodel.score[paramKeys[i]]=oldScoreInfo[paramKeys[i]];return vmodel.score.inputScoreRank=oldScoreInfo.inputScoreRank,!0}return!1},scoreHasChange:function(myScore){var paramKeys=vmodel.scoreKeys(myScore),change=!1;for(var key in myScore)if(paramKeys.indexOf(key)>-1&&("scoreRank"==key&&(key="inputScoreRank"),oldScoreInfo[key]!=myScore[key])){change=!0;break}return change},validScore:function(myScore){var provid=myScore.prov,msg="";return"31"==myScore.prov||"33"==myScore.prov?(window.zhejiangTipPopup(function(){}),!1):(myScore.scoreRank>999999?msg="您输入的排名异常":myScore.realScore<=0?msg="请输入您的高考分数":vmodel.rankRequire&&myScore.inputScoreRank<=0?msg="请输入您的高考排名":33==provid&&(!myScore.zj_opt_course||myScore.zj_opt_course.length<3)?msg="请选择三项选考科目":46==provid&&myScore.realScore>940?msg="您输入的成绩已超过满分":31==provid&&myScore.realScore>660?msg="您输入的成绩已超过满分":32==provid&&myScore.realScore>480?msg="您输入的成绩已超过满分":-1==$.inArray(1*provid,[31,32,46])&&myScore.realScore>750&&(msg="您输入的成绩已超过满分"),!msg||(showMsg(msg),!1))},makeSure:function(myScore){var update_count,that=this;this.oldScoreInfo&&(update_count=this.oldScoreInfo.update_count-1);var update_count_txt;update_count_txt=update_count>0?"你当前只能再修改"+update_count+"次修改成绩":"成绩将被锁定，不可再修改";var actTip='<div class="waringContent">您所在省份已经公布高考成绩，为保证推荐准确性，<span class="warning">'+update_count_txt+"</span>，请确保输入成绩无误。</div>";pin.use("richAlert",{extension:"wideContent",alertType:"warn",title:"成绩修改后将被锁定",content:actTip,towBtns:!1,okTxt:"我知道了",okCallback:function(){that.scoreConfirm(myScore)},uiEvent:function(){var self=this;self.jq(".act").css({width:"170px",margin:"30px auto 0px",display:"block"}),self.jq(".title span").css({color:"#f74c53"})}}).display(1)},scoreConfirm:function(myScore){var content='<div class="wideContent"><p><span class="label">省份文理</span>'+vmodel.provName+" | "+(1==myScore.wenli?"文科":"理科")+"</p>";if(32==myScore.prov){var xuance=(2==myScore.wenli?"物理":"历史")+myScore.req_level;xuance+=" | "+myScore.opt_courseCfg[myScore.opt_course]+myScore.opt_level,xuance='<p><span class="label">选测科目</span>'+xuance+"</p>",content+=xuance}if(content+='<p><span class="label">高考分数</span>'+myScore.realScore+" 分</p>",(vmodel.rankRequire||myScore.scoreRank)&&(content+='<p><span class="label">全省排名</span>'+myScore.scoreRank+" 名</p>"),myScore.diploma_id&&""!==myScore.diploma_id){content+='<p><span class="label">填报批次</span>'+(7===myScore.diploma_id?"本科":"专科 ")+"</p>"}content+="</div>";var update_count_txt,update_count=oldScoreInfo.update_count-1;update_count_txt=update_count>0?"只能再修改"+update_count+"次":"成绩将被锁定，不可再修改";var actTip='<div class="wideContent-act-tip"><div class="ui-checkbox"><span class="ui-checkbox-value" data-value="1"><i class="ui-checkbox-state"></i></span></div>点击 “确定” 后，<span class="strong">'+update_count_txt+"</span></div>";pin.use("richAlert",{extension:"wideContent",alertType:"warn",title:"请再次确认以下信息",content:content+actTip,towBtns:!0,okTxt:"确定",okCallback:function(){if(!this.jq().find(".wideContent-act-tip .ui-checkbox-value").hasClass("ui-checked"))return!1;vmodel.doSaveFn()},cancelTxt:"重新输入",cancelCallback:function(){},uiEvent:function(){this.jq().find(".wideContent-act-tip").on("click",".ui-checkbox-value",function(){$(this).hasClass("ui-checked")?$(this).removeClass("ui-checked"):$(this).addClass("ui-checked")})}}).display(1)},submit:function(e){$(".use_fraction input").length&&(vmodel.score.realScore=$(".use_fraction input").val()),$(".use_ranking input").length&&(vmodel.score.scoreRank=$(".use_ranking input").val());var myScore=vmodel.score.$model;if(!vmodel.scoreHasChange(myScore)&&myScore.realScore>0)return vmodel.updateCallback(myScore),vmodel.display=!1,!0;if(vmodel.isLocked(myScore))return showMsg("你已编辑过1次，成绩已锁定"),!1;if(!vmodel.validScore(myScore))return!1;if(hasScore)vmodel.confirmSave();else{var actTip='<div class="wideContent-act-tip" style="margin-top: -15px;">当前选择的省份为：<span class="strong">'+vmodel.provName+"</span></div>";pin.use("richAlert",{extension:"wideContent",alertType:"warn",title:"省份选择后不可再修改",content:actTip,towBtns:!0,okTxt:"确定",okCallback:function(){vmodel.confirmSave()},cancelTxt:"返回修改",cancelCallback:function(){},uiEvent:function(){this.jq(".act .btn:last").css({background:"#00AFF0",color:"white","border-color":"#00AFF0"})}}).display(1)}return!1},scoreKeys:function(myScore){var paramKeys=["prov","realScore","scoreRank","score","wenli","diploma_id"];return"32"==myScore.prov?paramKeys=paramKeys.concat(["req_course","opt_course","req_level","opt_level"]):"31"!=myScore.prov&&"33"!=myScore.prov||(paramKeys=paramKeys.concat(["zj_opt_course"])),paramKeys},confirmSave:function(){var myScore=vmodel.score.$model;vmodel.modifyLimit?vmodel.makeSure(myScore):vmodel.doSaveFn()},doSaveFn:function(){for(var myScore=avalon.mix({},vmodel.score.$model),params={},paramKeys=vmodel.scoreKeys(myScore),i=0;i<paramKeys.length;i++)params[paramKeys[i]]=myScore[paramKeys[i]];params.score_form=vmodel.saveScoreForm,Req.score(params,function(res){var data=res.data;if(0!=data.code)alert(data.msg);else{var newScoreInfo=data.data.myScore;oldScoreInfo.update_count=Math.max(0,oldScoreInfo.update_count-1),oldScoreInfo=myScore=newScoreInfo,vmodel.updateCallback(myScore),vmodel.display=!1}})},resetFields:function(){var listConfig={prov:"prov_list",req_level:"req_level_list",opt_course:"opt_course_list",opt_level:"opt_level_list"},keys=vmodel.scoreKeys(vmodel.score);for(var k in vmodel.score)keys.indexOf(k)>-1&&k in oldScoreInfo&&(vmodel.score[k]=oldScoreInfo[k],k in listConfig&&(listVm=avalon.vmodels[listConfig[k]],listVm&&listVm._setItem&&listVm._setItem(vmodel.score[k]+"")))},show:function(frag){var isSEOChannel=/^sogou|360$/.test(PageData.channel||"");if(0==PageData.isLogin&&0==isSEOChannel)return console.log("scoreUI, uid:",PageData.uid,"please login"),void ipinAuth.loginBox();frag=!!frag,frag?vmodel.allowModify?(vmodel.resetFields(),vmodel.display=!0):showMsg("你已编辑过1次，成绩已锁定"):vmodel.display=!1},closeFn:function(e){return vmodel.display=!1,vmodel.score=oldScoreInfo,e.preventDefault(),!1}});return!notAllowClose&&mask.click(function(){vmodel.display=!1}),vmodel.$watch("display",function(v){v?mask&&mask.show():mask&&mask.hide()}),$(".use_ranking input ,.use_fraction input").on("input",function(){this.value=parseInt(this.value)||""}),vmodel.score.$watch("realScore",function(v,old){vmodel.score.realScore=parseInt(1*v)||"",vmodel.score.realScore>=0&&vmodel.score.realScore!=oldScoreInfo.realScore&&(vmodel.score.hasScore=!(!vmodel.score.realScore&&!vmodel.score.scoreRank),vmodel.score.scoreRank||(vmodel.score.infoType="score"))}),vmodel.score.$watch("inputScoreRank",function(v,old){vmodel.score.inputScoreRank=parseInt(1*v)||"",vmodel.score.inputScoreRank>=0&&vmodel.score.inputScoreRank!=old&&(vmodel.score.inputScoreRank==oldScoreInfo.inputScoreRank?vmodel.score.scoreRank=oldScoreInfo.scoreRank:vmodel.score.scoreRank=vmodel.score.inputScoreRank,vmodel.score.hasScore=!(!vmodel.score.realScore&&!vmodel.score.scoreRank),vmodel.score.infoType="rank")}),avalon.nextTick(function(){avalon.scan(element[0],[vmodel])}),vmodel};return window.showScoreUi="loaded",showScore});
//# sourceMappingURL=score.js.map